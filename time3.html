<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time & Solat</title>

    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: "Segoe UI", Arial, sans-serif;
            color: #ffffff;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        body::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url('time-background.jpeg');
            background-size: cover;
            background-position: center;
            filter: brightness(0.45);
            z-index: -1;
        }

        #time {
            font-size: clamp(4rem, 15vw, 18rem);
            font-weight: 700;
            line-height: 1;
        }

        #date {
            font-size: clamp(1.2rem, 4vw, 3rem);
            margin-top: 0.5vh;
        }

        #next-solat {
            margin-top: 1vh;
            font-size: 2.5rem;
            font-weight: 600;
        }

        #iqamat {
            font-size: 2rem;
            opacity: 0.9;
            margin-bottom: 2vh;
        }

        #solat {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }

        .solat-box {
            border: 2px solid #ffffff;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            min-width: 130px;
            background: rgba(0, 0, 0, 0.5);
        }

        .solat-box h3 {
            margin: 0;
            font-size: 3rem;
        }

        .solat-box span {
            font-size: 2.2rem;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div id="time">00:00:00 AM</div>
    <div id="date">Loadingâ€¦</div>

    <div id="next-solat"></div>
    <div id="iqamat"></div>

    <div id="solat"></div>

    <script>
        /* ========= UTIL ========= */
        function toAmPm(time24) {
            const [h, m] = time24.split(":");
            let hour = parseInt(h);
            const ampm = hour >= 12 ? "PM" : "AM";
            hour = hour % 12 || 12;
            return `${hour}:${m} ${ampm}`;
        }

        function formatHMS(ms) {
            const total = Math.floor(ms / 1000);
            const h = Math.floor(total / 3600);
            const m = Math.floor((total % 3600) / 60);
            const s = total % 60;
            return `${String(h).padStart(2, "0")}j ${String(m).padStart(2, "0")}m ${String(s).padStart(2, "0")}s`;
        }

        /* ========= CLOCK ========= */
        function updateClock() {
            const now = new Date();
            document.getElementById("time").textContent =
                now.toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: true
                });

            document.getElementById("date").textContent =
                now.toLocaleDateString([], {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric"
                });
        }
        setInterval(updateClock, 1000);
        updateClock();

        /* ========= DATA ========= */
        let solatTimes = [];
        let iqamatMap = {};
        let reloaded = false;

        /* ========= LOAD IQAMAT ========= */
        async function loadIqamat() {
            const res = await fetch("iqamat.txt");
            const text = await res.text();
            text.trim().split("\n").forEach(line => {
                const [name, min] = line.split(",");
                iqamatMap[name.trim()] = parseInt(min);
            });
        }

        /* ========= LOAD SOLAT ========= */
        async function loadSolat() {
            const today = new Date().toISOString().slice(0, 10);
            const res = await fetch("solat.txt");
            const text = await res.text();
            const line = text.split("\n").find(l => l.startsWith(today));
            if (!line) return;

            const parts = line.split(",");
            const names = ["Imsak", "Subuh", "Syuruk", "Zohor", "Asar", "Maghrib", "Isyak"];

            solatTimes = names.map((n, i) => ({
                name: n,
                time: parts[i + 1]
            }));

            const solatDiv = document.getElementById("solat");
            solatDiv.innerHTML = "";

            solatTimes.forEach(s => {
                const box = document.createElement("div");
                box.className = "solat-box";
                box.innerHTML = `<h3>${s.name}</h3><span>${toAmPm(s.time)}</span>`;
                solatDiv.appendChild(box);
            });
        }

        /* ========= NEXT SOLAT + IQAMAT ========= */
        function updateNextSolat() {
            const now = new Date();

            for (let i = 0; i < solatTimes.length; i++) {
                const s = solatTimes[i];
                const [h, m] = s.time.split(":");
                const solatTime = new Date();
                solatTime.setHours(h, m, 0, 0);

                if (solatTime > now) {
                    document.getElementById("next-solat").textContent =
                        `Solat seterusnya: ${s.name} (${formatHMS(solatTime - now)})`;
                    document.getElementById("iqamat").textContent = "";
                    return;
                }

                const next = solatTimes[i + 1];
                if (next && iqamatMap[s.name]) {
                    const [nh, nm] = next.time.split(":");
                    const nextTime = new Date();
                    nextTime.setHours(nh, nm, 0, 0);

                    if (now < nextTime) {
                        const iqTime = new Date(solatTime.getTime() + iqamatMap[s.name] * 60000);
                        document.getElementById("next-solat").textContent =
                            `Solat sekarang: ${s.name}`;

                        if (now < iqTime) {
                            document.getElementById("iqamat").textContent =
                                `Iqamat dalam ${formatHMS(iqTime - now)}`;
                        } else {
                            document.getElementById("iqamat").textContent = "Iqamat sekarang";
                        }
                        return;
                    }
                }
            }

            /* ========= AUTO RELOAD SELEPAS ISYAK ========= */
            const isyak = solatTimes.find(s => s.name === "Isyak");
            if (isyak && !reloaded) {
                const [h, m] = isyak.time.split(":");
                const reloadTime = new Date();
                reloadTime.setHours(h, parseInt(m) + (iqamatMap["Isyak"] || 10) + 5, 0, 0);
                if (now > reloadTime) {
                    reloaded = true;
                    location.reload();
                }
            }

            document.getElementById("next-solat").textContent = "Menunggu solat esok";
            document.getElementById("iqamat").textContent = "";
        }

        /* ========= INIT ========= */
        async function init() {
            await loadIqamat();
            await loadSolat();
            setInterval(updateNextSolat, 1000);
        }
        init();
    </script>

</body>

</html>